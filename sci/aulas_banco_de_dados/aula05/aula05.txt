TMP_VEF_EMP_LANAGRUP_TEMP
(BDSESSAO, BDCODEMP, BDREFLAN, BDCODPROD -> INTEGER
 BDVLRICMS -> INTEGER)

CREATE TABLE TMP_VEF_EMP_LANAGRUP_TEMP(
    BDSESSAO INTEGER, 
    BDCODEMP INTEGER, 
    BDREFLAN INTEGER, 
    BDCODPROD INTEGER,
    BDVLRICMS DM_NUMERIC_15_2
);

--INSERT com SELECT. O resultado do select é atribuído ao INSERT
INSERT INTO TMP_VEF_EMP_LANAGRUP_TEMP(BDSESSAO, BDCODEMP, BDREFLAN, BDCODPROD, BDVLRICMS)
SELECT FIRST 3 5, ENT.BDCODEMP, ENT.BDREFLAN, 150, ENT.BDVALORNOTA
FROM VEF_EMP_TMOVENT ENT



--SELECT NAS TABELAS ENTRADA E SAÍDA(MOVPRO), PEGANDO OS CAMPOS
--DA TABELA MOVPRO E LEVANDO PRA TABELA TEMPORÁRIA
--EMPRESA 67 E REFERÊNCIA 202101

INSERT INTO TMP_VEF_EMP_LANAGRUP_TEMP(BDSESSAO, BDCODEMP, BDREFLAN, BDCODPROD, BDVLRICMS)

SELECT 5, ENT.BDCODEMP, ENT.BDREFLAN, PROD.BDCODPROD, PROD.BDVLRICMS
FROM (
    SELECT ENT.*
    FROM VEF_EMP_TMOVENT ENT
    WHERE ENT.BDCODEMP = 67 AND ENT.BDREFLAN = 202101
     ) ENT
JOIN VEF_EMP_TMOVENTITENS ITENS ON 
(ITENS.BDCODEMP = ENT.BDCODEMP AND ITENS.BDCHAVE = ENT.BDCHAVE)
JOIN VEF_EMP_TMOVPROENT PROD ON 
(PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)

UNION ALL

SELECT 5, SAI.BDCODEMP, SAI.BDREFLAN, PROD.BDCODPROD, PROD.BDVLRICMS
FROM (
    SELECT SAI.*
    FROM VEF_EMP_TMOVSAI SAI
    WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
     ) SAI
JOIN VEF_EMP_TMOVSAIITENS ITENS ON
(ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
JOIN VEF_EMP_TMOVPROSAI PROD ON
(PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)


--INSERIR DA TABELA TEMPORÁRIA PARA A TABELA FÍSICA VEF_EMP_TAJUICMSE111
--OS CAMPOS BDCODEMP, BDORDEME111220, BDREFERENCIA, BDVLRAJU
--INSERIR A SOMA DO VALOR DE ICMS AGRUPANDO BDCODEMP, BDREFLAN E BDCODPROD

INSERT INTO VEF_EMP_TAJUICMSE111 (BDCODEMP, BDORDEME111220, BDREFERENCIA, BDVLRAJU)
SELECT T.BDCODEMP, GETORDEMSEQUENCIAL(T.BDCODEMP), T.BDREFLAN, SUM(T.BDVLRICMS) BDVLRICMS
FROM TMP_VEF_EMP_LANAGRUP_TEMP T
GROUP BY T.BDCODEMP, T.BDREFLAN,  T.BDCODPROD
