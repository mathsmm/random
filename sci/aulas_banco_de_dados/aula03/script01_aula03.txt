--1. Fazer SQL buscando os lançamentos
--de entrada e saída separados (SubSELECT)

/*
WHERE EMPRESA(BDCODEMP) 67 E REFERÊNCIA(BDREFLAN) 202101
VEF_EMP_TMOVENT                --> PRINCIPAL DE ENTRADA
VEF_EMP_TMOVENTITENS(BDCODNAT) --> ITENS DA ENTRADA (TEM FK COM MOVENT)
VEF_EMP_TMOVPROENT(BDCODPROD)  --> PRODUTOS DA ENTRADA (TEM FK COM A DE ITENS)

VEF_EMP_TMOVSAI      --> PRINCIPAL DE SAÍDA
VEF_EMP_TMOVSAIITENS --> ITENS DA SAÍDA (TEM FK COM MOVSAI)
VEF_EMP_TMOVPROSAI   --> PRODUTOS DA SAÍDA (TEM FK COM A DE ITENS)
*/

--ENTRADA:
SELECT *
FROM (
    SELECT ENT.*
    FROM VEF_EMP_TMOVENT ENT
    WHERE ENT.BDCODEMP = 67 AND ENT.BDREFLAN = 202101
     ) ENT
JOIN VEF_EMP_TMOVENTITENS ITENS ON 
(ITENS.BDCODEMP = ENT.BDCODEMP AND ITENS.BDCHAVE = ENT.BDCHAVE)
JOIN VEF_EMP_TMOVPROENT PROD ON
(PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)

--SAÍDA:
SELECT *
FROM (
    SELECT SAI.*
    FROM VEF_EMP_TMOVSAI SAI
    WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
     ) SAI
JOIN VEF_EMP_TMOVSAIITENS ITENS ON
(ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
JOIN VEF_EMP_TMOVPROSAI PROD ON
(PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)


--2. Buscar a descrição do produto(BDCODPROD) e
a descrição do CodNat(BDCODNAT)
/*
TCADPRO_VINC
*/

--ENTRADA:
SELECT PROD.BDCODPROD, 
       VINC.BDDESCPROD, 
       NAT.BDCODNAT, 
       NAT.BDNOMENAT
FROM (
    SELECT ENT.*
    FROM VEF_EMP_TMOVENT ENT
    WHERE ENT.BDCODEMP = 67 AND ENT.BDREFLAN = 202101
     ) ENT
JOIN VEF_EMP_TMOVENTITENS ITENS ON 
(ITENS.BDCODEMP = ENT.BDCODEMP AND ITENS.BDCHAVE = ENT.BDCHAVE)
JOIN VEF_EMP_TMOVPROENT PROD ON 
(PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
JOIN TCADPRO_VINC VINC ON
(VINC.BDCODEMP = PROD.BDCODEMP AND VINC.BDCODPROD = PROD.BDCODPROD)
JOIN VEF_BASE_TNATOP NAT ON
(NAT.BDCODNAT = ITENS.BDCODNAT)

--SAÍDA:
SELECT PROD.BDCODPROD, 
       VINC.BDDESCPROD, 
       NAT.BDCODNAT, 
       NAT.BDNOMENAT
FROM (
    SELECT SAI.*
    FROM VEF_EMP_TMOVSAI SAI
    WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
     ) SAI
JOIN VEF_EMP_TMOVSAIITENS ITENS ON
(ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
JOIN VEF_EMP_TMOVPROSAI PROD ON
(PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
JOIN TCADPRO_VINC VINC ON
(VINC.BDCODEMP = PROD.BDCODEMP AND VINC.BDCODPROD = PROD.BDCODPROD)
JOIN VEF_BASE_TNATOP NAT ON
(NAT.BDCODNAT = ITENS.BDCODNAT)


--Os dois SELECTs anteriores unidos:
SELECT VINC.BDDESCPROD, NAT.BDCODNAT, NAT.BDNOMENAT
FROM (
    SELECT ENT.BDCODEMP, PROD.BDCODPROD, ITENS.BDCODNAT
    FROM (
        SELECT ENT.*
        FROM VEF_EMP_TMOVENT ENT
        WHERE ENT.BDCODEMP = 67 AND ENT.BDREFLAN = 202101
         ) ENT
    JOIN VEF_EMP_TMOVENTITENS ITENS ON 
    (ITENS.BDCODEMP = ENT.BDCODEMP AND ITENS.BDCHAVE = ENT.BDCHAVE)
    JOIN VEF_EMP_TMOVPROENT PROD ON 
    (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)

    UNION ALL

    SELECT SAI.BDCODEMP, PROD.BDCODPROD, ITENS.BDCODNAT
    FROM (
        SELECT SAI.*
        FROM VEF_EMP_TMOVSAI SAI
        WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
         ) SAI
    JOIN VEF_EMP_TMOVSAIITENS ITENS ON
    (ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
    JOIN VEF_EMP_TMOVPROSAI PROD ON
    (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
     ) SUB
JOIN TCADPRO_VINC VINC ON
(VINC.BDCODEMP = SUB.BDCODEMP AND VINC.BDCODPROD = SUB.BDCODPROD)
JOIN VEF_BASE_TNATOP NAT ON
(NAT.BDCODNAT = SUB.BDCODNAT)