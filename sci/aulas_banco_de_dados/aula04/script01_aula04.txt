--3. Buscar o nome do Terceiro da VIEW VW_TTERICEIRO
--Tabela do BDCODTER --> VEF_EMP_TMOVENT e VEF_EMP_TMOVSAI

EXECUTE PROCEDURE SP_SETA_COMPETENCIA(202108) --> Deve ser executado separadamente

SELECT VINC.BDDESCPROD, NAT.BDCODNAT, NAT.BDNOMENAT, SUB.BDCODTER, TER.BDREFEMP, TER.BDNOMETER
FROM (
    SELECT ENT.BDCODEMP, PROD.BDCODPROD, ITENS.BDCODNAT, ENT.BDCODTER
    FROM (
        SELECT ENT.*
        FROM VEF_EMP_TMOVENT ENT
        WHERE ENT.BDCODEMP = 67 AND ENT.BDREFLAN = 202101
         ) ENT
    JOIN VEF_EMP_TMOVENTITENS ITENS ON 
    (ITENS.BDCODEMP = ENT.BDCODEMP AND ITENS.BDCHAVE = ENT.BDCHAVE)
    JOIN VEF_EMP_TMOVPROENT PROD ON 
    (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)

    UNION ALL

    SELECT SAI.BDCODEMP, PROD.BDCODPROD, ITENS.BDCODNAT, SAI.BDCODTER
    FROM (
        SELECT SAI.*
        FROM VEF_EMP_TMOVSAI SAI
        WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
         ) SAI
    JOIN VEF_EMP_TMOVSAIITENS ITENS ON
    (ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
    JOIN VEF_EMP_TMOVPROSAI PROD ON
    (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
     ) SUB
JOIN TCADPRO_VINC VINC ON
(VINC.BDCODEMP = SUB.BDCODEMP AND VINC.BDCODPROD = SUB.BDCODPROD)
JOIN VEF_BASE_TNATOP NAT ON
(NAT.BDCODNAT = SUB.BDCODNAT)
JOIN VW_TTERCEIRO TER ON
(TER.BDCODTER = SUB.BDCODTER)


--4. Retornar o produto mais vendido (somar
--a quantidade do campo BDQTDITEM(VEF_EMP_TMOVPROSAI)
--Produto 99620 - LEITE - Quantidade 80
--BDCODEMP = 67 AND BDREFLAN = 202101

EXECUTE PROCEDURE SP_SETA_COMPETENCIA(202101)

SELECT /*FIRST 1*/ SUM(SUB.BDQTDITEM), VINC.BDDESCPROD, NAT.BDCODNAT, NAT.BDNOMENAT, SUB.BDCODTER, TER.BDREFEMP, TER.BDNOMETER
FROM (
    SELECT SAI.BDCODEMP, PROD.BDCODPROD, ITENS.BDCODNAT, SAI.BDCODTER, PROD.BDQTDITEM
    FROM (
        SELECT SAI.*
        FROM VEF_EMP_TMOVSAI SAI
        WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
         ) SAI
    JOIN VEF_EMP_TMOVSAIITENS ITENS ON
    (ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
    JOIN VEF_EMP_TMOVPROSAI PROD ON
    (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
     ) SUB
JOIN TCADPRO_VINC VINC ON
(VINC.BDCODEMP = SUB.BDCODEMP AND VINC.BDCODPROD = SUB.BDCODPROD)
JOIN VEF_BASE_TNATOP NAT ON
(NAT.BDCODNAT = SUB.BDCODNAT)
JOIN VW_TTERCEIRO TER ON
(TER.BDCODTER = SUB.BDCODTER)
WHERE SUB.BDCODEMP = 67
GROUP BY VINC.BDDESCPROD, NAT.BDCODNAT, NAT.BDNOMENAT, SUB.BDCODTER, TER.BDREFEMP, TER.BDNOMETER
ORDER BY SUM(SUB.BDQTDITEM) DESC


--5. Retornar qual o lan√ßamento que teve o
--maior valor(BDVALORNOTA da VEF_EMP_TMOVSAI)
--de venda
--Empresa 67 Chave 15 - Valor 1.203,75

EXECUTE PROCEDURE SP_SETA_COMPETENCIA(202101)

SELECT /*FIRST 1*/ MAX(SUB.BDVALORNOTA), SUB.BDCHAVE
FROM (
    SELECT SAI.BDCODEMP, PROD.BDCODPROD, ITENS.BDCODNAT, SAI.BDCODTER, PROD.BDQTDITEM, SAI.BDVALORNOTA, ITENS.BDCHAVE
    FROM (
        SELECT SAI.*
        FROM VEF_EMP_TMOVSAI SAI
        WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
         ) SAI
    JOIN VEF_EMP_TMOVSAIITENS ITENS ON
    (ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
    JOIN VEF_EMP_TMOVPROSAI PROD ON
    (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
     ) SUB
JOIN TCADPRO_VINC VINC ON
(VINC.BDCODEMP = SUB.BDCODEMP AND VINC.BDCODPROD = SUB.BDCODPROD)
JOIN VEF_BASE_TNATOP NAT ON
(NAT.BDCODNAT = SUB.BDCODNAT)
JOIN VW_TTERCEIRO TER ON
(TER.BDCODTER = SUB.BDCODTER)
WHERE SUB.BDCODEMP = 67 AND SUB.BDCHAVE = 15
GROUP BY SUB.BDCHAVE
ORDER BY SUM(SUB.BDVALORNOTA) DESC